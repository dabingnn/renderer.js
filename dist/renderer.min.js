var renderer=function(e,t,r){"use strict";e=e&&"default"in e?e["default"]:e;var i=function(t){var r=document.createElement("canvas");var i=r.getContext("2d");r.width=r.height=128;i.fillStyle="#ddd";i.fillRect(0,0,128,128);i.fillStyle="#555";i.fillRect(0,0,64,64);i.fillStyle="#555";i.fillRect(64,64,64,64);var n=new e.Texture2D(t,{images:[r],width:128,height:128,wrapS:e.WRAP_REPEAT,wrapT:e.WRAP_REPEAT,format:e.TEXTURE_FMT_RGB8,mipmap:true});return{defaultTexture:n}};var n=function(e){var t={};Object.assign(t,i(e));return t};var a={PP_PROJECTION:0,PP_ORTHO:1,STAGE_OPAQUE:1,STAGE_TRANSPARENT:2,STAGE_SHADOWCAST:4,PARAM_INT:0,PARAM_INT2:1,PARAM_INT3:2,PARAM_INT4:3,PARAM_FLOAT:4,PARAM_FLOAT2:5,PARAM_FLOAT3:6,PARAM_FLOAT4:7,PARAM_COLOR3:8,PARAM_COLOR4:9,PARAM_MAT2:10,PARAM_MAT3:11,PARAM_MAT4:12,PARAM_TEXTURE_2D:13,PARAM_TEXTURE_CUBE:14};var s=t.mat3.create();var o=t.mat4.create();var _=new r.FramePool(function(){return{stage:null,items:null}},8);var l=new r.FramePool(function(){return new Float32Array(2)},8);var c=new r.FramePool(function(){return new Float32Array(3)},8);var h=new r.FramePool(function(){return new Float32Array(4)},8);var u=new r.FramePool(function(){return new Float32Array(9)},8);var f=new r.FramePool(function(){return new Float32Array(16)},8);var d=new r.FramePool(function(){return new Int32Array(2)},8);var v=new r.FramePool(function(){return new Int32Array(3)},8);var A=new r.FramePool(function(){return new Int32Array(3)},8);var p={};p[a.PARAM_INT]=function(e){return e};p[a.PARAM_INT2]=function(e){return t.vec2.array(d.alloc(),e)};p[a.PARAM_INT3]=function(e){return t.vec3.array(v.alloc(),e)};p[a.PARAM_INT4]=function(e){return t.vec4.array(A.alloc(),e)};p[a.PARAM_FLOAT]=function(e){return e};p[a.PARAM_FLOAT2]=function(e){return t.vec2.array(l.alloc(),e)};p[a.PARAM_FLOAT3]=function(e){return t.vec3.array(c.alloc(),e)};p[a.PARAM_FLOAT4]=function(e){return t.vec4.array(h.alloc(),e)};p[a.PARAM_COLOR3]=function(e){return t.color3.array(c.alloc(),e)};p[a.PARAM_COLOR4]=function(e){return t.color4.array(h.alloc(),e)};p[a.PARAM_MAT2]=function(e){return t.mat2.array(h.alloc(),e)};p[a.PARAM_MAT3]=function(e){return t.mat3.array(u.alloc(),e)};p[a.PARAM_MAT4]=function(e){return t.mat4.array(f.alloc(),e)};var m=function(){function e(e,i){this._device=e;this._builtin=i;this._type2defaultValue=(n={},n[a.PARAM_INT]=0,n[a.PARAM_INT2]=t.vec2.new(0,0),n[a.PARAM_INT3]=t.vec3.new(0,0,0),n[a.PARAM_INT4]=t.vec4.new(0,0,0,0),n[a.PARAM_FLOAT]=0,n[a.PARAM_FLOAT2]=t.vec2.new(0,0),n[a.PARAM_FLOAT3]=t.vec3.new(0,0,0),n[a.PARAM_FLOAT4]=t.vec4.new(0,0,0,0),n[a.PARAM_COLOR3]=t.color3.new(0,0,0),n[a.PARAM_COLOR4]=t.color4.new(0,0,0,1),n[a.PARAM_MAT2]=t.mat2.create(),n[a.PARAM_MAT3]=t.mat3.create(),n[a.PARAM_MAT4]=t.mat4.create(),n[a.PARAM_TEXTURE_2D]=i.defaultTexture,n[a.PARAM_TEXTURE_CUBE]=i.defaultTextureCube,n);var n;this._stage2fn={};this._drawItemsPools=new r.FramePool(function(){return new r.RecyclePool(function(){return{node:null,mesh:null,material:null}},100)},16);this._stageItemsPools=new r.FramePool(function(){return new r.RecyclePool(function(){return{node:null,mesh:null,material:null,technique:null,zdist:-1}},100)},16)}e.prototype._reset=function e(){this._drawItemsPools.reset();this._stageItemsPools.reset()};e.prototype._render=function e(t,r,i){var n=this;var a=this._device;a.setViewport(0,0,t._rect.w,t._rect.h);a.clear({color:[.5,.5,.5,1],depth:1});var s=this._drawItemsPools.alloc();s.reset();for(var o=0;o<r._models.length;++o){var l=r._models.data[o];for(var c=0;c<l.meshCount;++c){var h=s.add();l.getDrawItem(h,c)}}_.reset();for(var u=0;u<i.length;++u){var f=i[u];var d=n._stageItemsPools.alloc();d.reset();for(var v=0;v<s.length;++v){var A=s.data[v];var p=A.material.getTechnique(f);if(p){var m=d.add();m.node=A.node;m.mesh=A.mesh;m.material=A.material;m.technique=p;m.zdist=-1}}var P=_.alloc();P.stage=f;P.items=d}for(var T=0;T<_.length;++T){var E=_.data[T];var F=n._stage2fn[E.stage];F(t,E.items)}};e.prototype._draw=function e(r){var i=this;var n=this._device;var _=r.node;var m=r.mesh;var P=r.material;var T=r.technique;l.reset();c.reset();h.reset();u.reset();f.reset();d.reset();v.reset();A.reset();var E=m._vertexBuffer.count;n.setVertexBuffer(0,m._vertexBuffer);if(m._indexBuffer){n.setIndexBuffer(m._indexBuffer);E=m._indexBuffer.count}_.getWorldMatrix(o);n.setUniform("model",t.mat4.array(f.alloc(),o));t.mat3.transpose(s,t.mat3.invert(s,t.mat3.fromMat4(s,o)));n.setUniform("normalMatrix",t.mat3.array(u.alloc(),s));var F=0;for(var R=0;R<T._properties.length;++R){var w=T._properties[R];var O=P.getParameter(w.name);if(O===undefined){O=w.val}if(O===undefined){O=i._type2defaultValue[w.type]}if(O===undefined){console.warn("Failed to set technique property "+w.name+", value not found.");continue}if(w.type===a.PARAM_TEXTURE_2D||w.type===a.PARAM_TEXTURE_CUBE){n.setTexture(w.name,O,F);++F}else{var M=p[w.type];var y=M(O);n.setUniform(w.name,y)}}n.setPrimitiveType(m._primitiveType);for(var S=0;S<T._passes.length;++S){var N=T._passes[S];n.setProgram(N._program);n.setCullMode(N._cullMode);if(N._blend){n.enableBlend();n.setBlendFuncSep(N._blendSrc,N._blendDst,N._blendSrcAlpha,N._blendDstAlpha);n.setBlendEqSep(N._blendEq,N._blendAlphaEq);n.setBlendColor32(N._blendColor)}if(N._depthTest){n.enableDepthTest();n.setDepthFunc(N._depthFunc)}if(N._depthWrite){n.enableDepthWrite()}if(N._stencilTest){n.enableStencilTest();n.setStencilFuncFront(N._stencilFuncFront,N._stencilRefFront,N._stencilMaskFront);n.setStencilOpFront(N._stencilFailOpFront,N._stencilZFailOpFront,N._stencilZPassOpFront,N._stencilWriteMaskFront);n.setStencilFuncBack(N._stencilFuncBack,N._stencilRefBack,N._stencilMaskBack);n.setStencilOpBack(N._stencilFailOpBack,N._stencilZFailOpBack,N._stencilZPassOpBack,N._stencilWriteMaskBack)}n.draw(0,E)}};return e}();var P=t.vec3.create();var T=t.vec3.create();var E=t.vec3.create();var F=new Float32Array(16);var R=new Float32Array(16);var w=new Float32Array(16);var O=function(e){function r(t,r){e.call(this,t,r);this._stage2fn[a.STAGE_OPAQUE]=this._opaqueStage.bind(this);this._stage2fn[a.STAGE_TRANSPARENT]=this._transparentStage.bind(this)}if(e)r.__proto__=e;r.prototype=Object.create(e&&e.prototype);r.prototype.constructor=r;r.prototype.render=function e(t,r){this._reset();t.updateMatrix();this._render(t,r,[a.STAGE_OPAQUE,a.STAGE_TRANSPARENT])};r.prototype._opaqueStage=function e(r,i){var n=this;this._device.setUniform("view",t.mat4.array(F,r._view));this._device.setUniform("proj",t.mat4.array(R,r._proj));this._device.setUniform("viewProj",t.mat4.array(w,r._viewProj));i.sort(function(e,t){e.technique.sortID()-t.technique.sortID()});for(var a=0;a<i.length;++a){var s=i.data[a];n._draw(s)}};r.prototype._transparentStage=function e(r,i){var n=this;this._device.setUniform("view",t.mat4.array(F,r._view));this._device.setUniform("proj",t.mat4.array(R,r._proj));this._device.setUniform("viewProj",t.mat4.array(w,r._viewProj));r._node.getWorldPos(P);t.vec3.set(T,-r._view.m02,-r._view.m06,-r._view.m10);for(var a=0;a<i.length;++a){var s=i.data[a];s.node.getWorldPos(E);t.vec3.sub(E,E,P);s.zdist=t.vec3.dot(E,T)}i.sort(function(e,t){return t.zdist-e.zdist});for(var o=0;o<i.length;++o){var _=i.data[o];n._draw(_)}};return r}(m);var M=function(e){var t=n(e);var r=new O(e,t);return{builtin:t,forward:r}};var y=function t(r,i,n){if(n===void 0)n=e.PT_TRIANGLES;this._vertexBuffer=r;this._indexBuffer=i;this._primitiveType=n};function S(t,r){if(!r.positions){console.error("The data must have positions field");return null}var i=[];var n=r.positions.length/3;for(var a=0;a<n;++a){i.push(r.positions[3*a],r.positions[3*a+1],r.positions[3*a+2]);if(r.normals){i.push(r.normals[3*a],r.normals[3*a+1],r.normals[3*a+2])}if(r.uvs){i.push(r.uvs[2*a],r.uvs[2*a+1])}}var s=[];s.push({name:e.ATTR_POSITION,type:e.ATTR_TYPE_FLOAT32,num:3});if(r.normals){s.push({name:e.ATTR_NORMAL,type:e.ATTR_TYPE_FLOAT32,num:3})}if(r.uvs){s.push({name:e.ATTR_UV,type:e.ATTR_TYPE_FLOAT32,num:2})}var o=new e.VertexBuffer(t,new e.VertexFormat(s),e.USAGE_STATIC,new Float32Array(i),n,false);var _=null;if(r.indices){_=new e.IndexBuffer(t,e.INDEX_FMT_UINT16,e.USAGE_STATIC,new Uint16Array(r.indices),r.indices.length,false)}return new y(o,_)}var N=function t(r){this._program=r;this._cullMode=e.CULL_BACK;this._blend=false;this._blendEq=e.BLEND_FUNC_ADD;this._blendAlphaEq=e.BLEND_FUNC_ADD;this._blendSrc=e.BLEND_ONE;this._blendDst=e.BLEND_ZERO;this._blendSrcAlpha=e.BLEND_ONE;this._blendDstAlpha=e.BLEND_ZERO;this._blendColor=4294967295;this._depthTest=false;this._depthWrite=false;this._depthFunc=e.DS_FUNC_LESS,this._stencilTest=false;this._stencilFuncFront=e.DS_FUNC_ALWAYS;this._stencilRefFront=0;this._stencilMaskFront=255;this._stencilFailOpFront=e.STENCIL_OP_KEEP;this._stencilZFailOpFront=e.STENCIL_OP_KEEP;this._stencilZPassOpFront=e.STENCIL_OP_KEEP;this._stencilWriteMaskFront=255;this._stencilFuncBack=e.DS_FUNC_ALWAYS;this._stencilRefBack=0;this._stencilMaskBack=255;this._stencilFailOpBack=e.STENCIL_OP_KEEP;this._stencilZFailOpBack=e.STENCIL_OP_KEEP;this._stencilZPassOpBack=e.STENCIL_OP_KEEP;this._stencilWriteMaskBack=255};N.prototype.setCullMode=function e(t){this._cullMode=t};N.prototype.setBlend=function t(r,i,n,a,s,o,_){if(r===void 0)r=e.BLEND_FUNC_ADD;if(i===void 0)i=e.BLEND_ONE;if(n===void 0)n=e.BLEND_ZERO;if(a===void 0)a=e.BLEND_FUNC_ADD;if(s===void 0)s=e.BLEND_ONE;if(o===void 0)o=e.BLEND_ZERO;if(_===void 0)_=4294967295;this._blend=true;this._blendEq=r;this._blendSrc=i;this._blendDst=n;this._blendAlphaEq=a;this._blendSrcAlpha=s;this._blendDstAlpha=o;this._blendColor=_};N.prototype.setDepth=function t(r,i,n){if(r===void 0)r=false;if(i===void 0)i=false;if(n===void 0)n=e.DS_FUNC_LESS;this._depthTest=r;this._depthWrite=i;this._depthFunc=n};N.prototype.setStencilFront=function t(r,i,n,a,s,o,_){if(r===void 0)r=e.DS_FUNC_ALWAYS;if(i===void 0)i=0;if(n===void 0)n=255;if(a===void 0)a=e.STENCIL_OP_KEEP;if(s===void 0)s=e.STENCIL_OP_KEEP;if(o===void 0)o=e.STENCIL_OP_KEEP;if(_===void 0)_=255;this._stencilTest=true;this._stencilFuncFront=r;this._stencilRefFront=i;this._stencilMaskFront=n;this._stencilFailOpFront=a;this._stencilZFailOpFront=s;this._stencilZPassOpFront=o;this._stencilWriteMaskFront=_};N.prototype.setStencilBack=function t(r,i,n,a,s,o,_){if(r===void 0)r=e.DS_FUNC_ALWAYS;if(i===void 0)i=0;if(n===void 0)n=255;if(a===void 0)a=e.STENCIL_OP_KEEP;if(s===void 0)s=e.STENCIL_OP_KEEP;if(o===void 0)o=e.STENCIL_OP_KEEP;if(_===void 0)_=255;this._stencilTest=true;this._stencilFuncBack=r;this._stencilRefBack=i;this._stencilMaskBack=n;this._stencilFailOpBack=a;this._stencilZFailOpBack=s;this._stencilZPassOpBack=o;this._stencilWriteMaskBack=_};var g=0;var B=function e(t,r,i){this._id=g++;this._passes=i;this._properties=r;this._stages=t};B.prototype.sortID=function e(){if(!this._passes.length){return-1}return((this._passes.length&15)<<24|(this._passes[0]._program.id&4095)<<12|this._id&65535)>>>0};var L=function e(t,r){if(r===void 0)r={};this._techniques=t;this._params=r};L.prototype.getTechnique=function e(t){var r=this;for(var i=0;i<this._techniques.length;++i){var n=r._techniques[i];if(n._stages&t){return n}}return null};L.prototype.getParameter=function e(t){return this._params[t]};L.prototype.setParameter=function e(t,r){this._params[t]=r};var C=function(){function e(){this._node=null;this._color=t.color3.create()}e.prototype.setNode=function e(t){this._node=t};return e}();var I=function(){function e(){this._node=null;this._perspective=a.PP_PROJECTION;this._near=.01;this._far=1e3;this._fov=Math.PI/4;this._orthoHeight=10;this._rect={x:0,y:0,w:1,h:1};this._scissor={x:0,y:0,w:1,h:1};this._color=t.color4.create();this._view=t.mat4.create();this._proj=t.mat4.create();this._viewProj=t.mat4.create();this._invViewProj=t.mat4.create()}e.prototype.setNode=function e(t){this._node=t};e.prototype.updateMatrix=function e(){this._node.getWorldMatrix(this._view);t.mat4.invert(this._view,this._view);var r=this._rect.w/this._rect.h;if(this._perspective===a.PP_PROJECTION){t.mat4.perspective(this._proj,this._fov,r,this._near,this._far)}else{var i=this._orthoHeight*r;var n=this._orthoHeight;t.mat4.ortho(this._proj,-i,i,-n,n,this._near,this._far)}t.mat4.mul(this._viewProj,this._proj,this._view);t.mat4.invert(this._invViewProj,this._viewProj)};return e}();var D=function(){function e(){this._node=null;this._meshes=[];this._materials=[]}var t={meshCount:{}};e.prototype.setNode=function e(t){this._node=t};e.prototype.addMesh=function e(t){if(this._meshes.indexOf(t)!==-1){return}this._meshes.push(t)};e.prototype.addMaterial=function e(t){if(this._materials.indexOf(t)!==-1){return}this._materials.push(t)};t.meshCount.get=function(){return this._meshes.length};e.prototype.getDrawItem=function e(t,r){if(r>=this._meshes.length){t.node=null;t.mesh=null;t.material=null;return}t.node=this._node;t.mesh=this._meshes[r];if(r<this._materials.length){t.material=this._materials[r]}else{t.material=this._materials[this._materials.length-1]}};Object.defineProperties(e.prototype,t);return e}();var b=function(){function e(){this._lights=new r.FixedArray(16);this._models=new r.FixedArray(16)}e.prototype.addModel=function e(t){var r=this._models.indexOf(t);if(r===-1){this._models.push(t)}};e.prototype.removeModel=function e(t){var r=this._models.indexOf(t);if(r!==-1){this._models.fastRemove(r)}};return e}();var U={create:M,createMesh:S,Pass:N,Technique:B,Material:L,Mesh:y,Light:C,Camera:I,Model:D,Scene:b,Renderer:m,ForwardRenderer:O};Object.assign(U,a);return U}(window.gfx,window.vmath,window.memop);
//# sourceMappingURL=renderer.min.js.map