var renderer=function(e,t,n){"use strict";e=e&&"default"in e?e["default"]:e;var r={PP_PROJECTION:0,PP_ORTHO:1,STAGE_OPAQUE:1,STAGE_TRANSPARENT:2,STAGE_SHADOWCAST:4,PARAM_INT:0,PARAM_INT2:1,PARAM_INT3:2,PARAM_INT4:3,PARAM_FLOAT:4,PARAM_FLOAT2:5,PARAM_FLOAT3:6,PARAM_FLOAT4:7,PARAM_COLOR3:8,PARAM_COLOR4:9,PARAM_MAT2:10,PARAM_MAT3:11,PARAM_MAT4:12,PARAM_TEXTURE_2D:13,PARAM_TEXTURE_CUBE:14};var i=function t(n,r,i){if(i===void 0)i=e.PT_TRIANGLES;this._vertexBuffer=n;this._indexBuffer=r;this._primitiveType=i};var a=function t(n){this._programName=n;this._cullMode=e.CULL_BACK;this._blend=false;this._blendEq=e.BLEND_FUNC_ADD;this._blendAlphaEq=e.BLEND_FUNC_ADD;this._blendSrc=e.BLEND_ONE;this._blendDst=e.BLEND_ZERO;this._blendSrcAlpha=e.BLEND_ONE;this._blendDstAlpha=e.BLEND_ZERO;this._blendColor=4294967295;this._depthTest=false;this._depthWrite=false;this._depthFunc=e.DS_FUNC_LESS,this._stencilTest=false;this._stencilFuncFront=e.DS_FUNC_ALWAYS;this._stencilRefFront=0;this._stencilMaskFront=255;this._stencilFailOpFront=e.STENCIL_OP_KEEP;this._stencilZFailOpFront=e.STENCIL_OP_KEEP;this._stencilZPassOpFront=e.STENCIL_OP_KEEP;this._stencilWriteMaskFront=255;this._stencilFuncBack=e.DS_FUNC_ALWAYS;this._stencilRefBack=0;this._stencilMaskBack=255;this._stencilFailOpBack=e.STENCIL_OP_KEEP;this._stencilZFailOpBack=e.STENCIL_OP_KEEP;this._stencilZPassOpBack=e.STENCIL_OP_KEEP;this._stencilWriteMaskBack=255};a.prototype.setCullMode=function e(t){this._cullMode=t};a.prototype.setBlend=function t(n,r,i,a,s,o,l){if(n===void 0)n=e.BLEND_FUNC_ADD;if(r===void 0)r=e.BLEND_ONE;if(i===void 0)i=e.BLEND_ZERO;if(a===void 0)a=e.BLEND_FUNC_ADD;if(s===void 0)s=e.BLEND_ONE;if(o===void 0)o=e.BLEND_ZERO;if(l===void 0)l=4294967295;this._blend=true;this._blendEq=n;this._blendSrc=r;this._blendDst=i;this._blendAlphaEq=a;this._blendSrcAlpha=s;this._blendDstAlpha=o;this._blendColor=l};a.prototype.setDepth=function t(n,r,i){if(n===void 0)n=false;if(r===void 0)r=false;if(i===void 0)i=e.DS_FUNC_LESS;this._depthTest=n;this._depthWrite=r;this._depthFunc=i};a.prototype.setStencilFront=function t(n,r,i,a,s,o,l){if(n===void 0)n=e.DS_FUNC_ALWAYS;if(r===void 0)r=0;if(i===void 0)i=255;if(a===void 0)a=e.STENCIL_OP_KEEP;if(s===void 0)s=e.STENCIL_OP_KEEP;if(o===void 0)o=e.STENCIL_OP_KEEP;if(l===void 0)l=255;this._stencilTest=true;this._stencilFuncFront=n;this._stencilRefFront=r;this._stencilMaskFront=i;this._stencilFailOpFront=a;this._stencilZFailOpFront=s;this._stencilZPassOpFront=o;this._stencilWriteMaskFront=l};a.prototype.setStencilBack=function t(n,r,i,a,s,o,l){if(n===void 0)n=e.DS_FUNC_ALWAYS;if(r===void 0)r=0;if(i===void 0)i=255;if(a===void 0)a=e.STENCIL_OP_KEEP;if(s===void 0)s=e.STENCIL_OP_KEEP;if(o===void 0)o=e.STENCIL_OP_KEEP;if(l===void 0)l=255;this._stencilTest=true;this._stencilFuncBack=n;this._stencilRefBack=r;this._stencilMaskBack=i;this._stencilFailOpBack=a;this._stencilZFailOpBack=s;this._stencilZPassOpBack=o;this._stencilWriteMaskBack=l};var s=0;var o=function e(t,n,r,i){if(i===void 0)i=0;this._id=s++;this._stages=t;this._parameters=n;this._passes=r;this._layer=i};o.prototype.sortID=function e(){if(!this._passes.length){return-1}return((this._passes.length&15)<<24|(this._passes[0]._program.id&4095)<<12|this._id&65535)>>>0};function l(t,n){if(!n.positions){console.error("The data must have positions field");return null}var r=[];var a=n.positions.length/3;for(var s=0;s<a;++s){r.push(n.positions[3*s],n.positions[3*s+1],n.positions[3*s+2]);if(n.normals){r.push(n.normals[3*s],n.normals[3*s+1],n.normals[3*s+2])}if(n.uvs){r.push(n.uvs[2*s],n.uvs[2*s+1])}}var o=[];o.push({name:e.ATTR_POSITION,type:e.ATTR_TYPE_FLOAT32,num:3});if(n.normals){o.push({name:e.ATTR_NORMAL,type:e.ATTR_TYPE_FLOAT32,num:3})}if(n.uvs){o.push({name:e.ATTR_UV,type:e.ATTR_TYPE_FLOAT32,num:2})}var l=new e.VertexBuffer(t,new e.VertexFormat(o),e.USAGE_STATIC,new Float32Array(r),a,false);var _=null;if(n.indices){_=new e.IndexBuffer(t,e.INDEX_FMT_UINT16,e.USAGE_STATIC,new Uint16Array(n.indices),n.indices.length,false)}return new i(l,_)}var _={opaque:r.STAGE_OPAQUE,transparent:r.STAGE_TRANSPARENT,shadowcast:r.STAGE_SHADOWCAST};var c={int:r.PARAM_INT,int2:r.PARAM_INT2,int3:r.PARAM_INT3,int4:r.PARAM_INT4,float:r.PARAM_FLOAT,float2:r.PARAM_FLOAT2,float3:r.PARAM_FLOAT3,float4:r.PARAM_FLOAT4,color3:r.PARAM_COLOR3,color4:r.PARAM_COLOR4,mat2:r.PARAM_MAT2,mat3:r.PARAM_MAT3,mat4:r.PARAM_MAT4,tex2d:r.PARAM_TEXTURE_2D,texcube:r.PARAM_TEXTURE_CUBE};var u={none:e.CULL_NONE,front:e.CULL_FRONT,back:e.CULL_BACK,front_and_back:e.CULL_FRONT_AND_BACK};var h={add:e.BLEND_FUNC_ADD,sub:e.BLEND_FUNC_SUBTRACT,reverse_sub:e.BLEND_FUNC_REVERSE_SUBTRACT};var f={zero:e.BLEND_ZERO,one:e.BLEND_ONE,src_color:e.BLEND_SRC_COLOR,one_minus_src_color:e.BLEND_ONE_MINUS_SRC_COLOR,dst_color:e.BLEND_DST_COLOR,one_minus_dst_color:e.BLEND_ONE_MINUS_DST_COLOR,src_alpha:e.BLEND_SRC_ALPHA,one_minus_src_alpha:e.BLEND_ONE_MINUS_SRC_ALPHA,dst_alpha:e.BLEND_DST_ALPHA,one_minus_dst_alpha:e.BLEND_ONE_MINUS_DST_ALPHA,constant_color:e.BLEND_CONSTANT_COLOR,one_minus_constant_color:e.BLEND_ONE_MINUS_CONSTANT_COLOR,constant_alpha:e.BLEND_CONSTANT_ALPHA,one_minus_constant_alpha:e.BLEND_ONE_MINUS_CONSTANT_ALPHA,src_alpha_saturate:e.BLEND_SRC_ALPHA_SATURATE};var p={never:e.DS_FUNC_NEVER,less:e.DS_FUNC_LESS,equal:e.DS_FUNC_EQUAL,lequal:e.DS_FUNC_LEQUAL,greater:e.DS_FUNC_GREATER,notequal:e.DS_FUNC_NOTEQUAL,gequal:e.DS_FUNC_GEQUAL,always:e.DS_FUNC_ALWAYS};var v={keep:e.STENCIL_OP_KEEP,zero:e.STENCIL_OP_ZERO,replace:e.STENCIL_OP_REPLACE,incr:e.STENCIL_OP_INCR,incr_wrap:e.STENCIL_OP_INCR_WRAP,decr:e.STENCIL_OP_DECR,decr_wrap:e.STENCIL_OP_DECR_WRAP,inver:e.STENCIL_OP_INVERT};function d(e,t){var n=e.split(" ");t&&t(h[n[0]],f[n[1]],f[n[2]])}function A(e,t){var n=e.split(" ");t&&t(p[n[0]],parseInt(n[1]),parseInt(n[2]),v[n[3]],v[n[4]],v[n[5]],parseInt(n[6]))}function m(e,t){var n=e.split(" ");t&&t(p[n[0]],n[1]==="true")}function T(e,t){var n=e.split(" ");t&&t(parseInt(n[0]),parseInt(n[1]))}function E(t,n){var r=[];var i=n;i.techniques.forEach(function(n){var s=[];n.passes.forEach(function(n){var r=null;T(n.program,function(n,a){r=new e.Program(t,{vert:i.vertexShaders[n],frag:i.fragmentShaders[a]});r.link()});var o=new a(r);if(n.blend){o._blend=true;d(n.blend,function(e,t,n){o._blendEq=e;o._blendSrc=t;o._blendDst=n});if(n.blendAlpha){d(n.blendAlpha,function(e,t,n){o._blendAlphaEq=e;o._blendSrcAlpha=t;o._blendDstAlpha=n})}else{o._blendAlphaEq=o._blendEq;o._blendSrcAlpha=o._blendSrc;o._blendDstAlpha=o._blendDst}if(n.blendColor){o._blendColor=parseInt(n.blendColor)}}if(n.cull){o._cullMode=u[n.cull]}if(n.depth){o._depthTest=true;m(n.depth,function(e,t){o._depthFunc=e;o._depthWrite=t})}if(n.stencil){o._stencilTest=true;A(n.stencil,function(e,t,n,r,i,a,s){o._stencilFuncFront=e;o._stencilRefFront=e;o._stencilMaskFront=n;o._stencilFailOpFront=r;o._stencilZFailOpFront=i;o._stencilZPassOpFront=a;o._stencilWriteMaskFront=s});if(n.stencilBack){A(n.stencilBack,function(e,t,n,r,i,a,s){o._stencilFuncBack=e;o._stencilRefBack=e;o._stencilMaskBack=n;o._stencilFailOpBack=r;o._stencilZFailOpBack=i;o._stencilZPassOpBack=a;o._stencilWriteMaskBack=s})}else{o._stencilFuncBack=o._stencilFuncFront;o._stencilRefBack=o._stencilRefFront;o._stencilMaskBack=o._stencilMaskFront;o._stencilFailOpBack=o._stencilFailOpFront;o._stencilZFailOpBack=o._stencilZFailOpFront;o._stencilZPassOpBack=o._stencilZPassOpFront;o._stencilWriteMaskBack=o._stencilWriteMaskFront}}s.push(o)});var l=0;n.stages.split(" ").forEach(function(e){l=l|_[e]});var h=[];for(var f in n.parameters){h.push({name:f,type:c[n.parameters[f].type]})}var p=new o(l,h,s);r.push(p)});return r}var P=function e(t,n,r){if(n===void 0)n={};if(r===void 0)r={};this._techniques=t;this._values=n;this._options=r};P.prototype.getTechnique=function e(t){var n=this;for(var r=0;r<this._techniques.length;++r){var i=n._techniques[r];if(i._stages&t){return i}}return null};P.prototype.getValue=function e(t){return this._values[t]};P.prototype.setValue=function e(t,n){this._values[t]=n};P.prototype.getOption=function e(t){return this._options[t]};P.prototype.setOption=function e(t,n){this._options[t]=n};var O=function e(){this._node=null;this._color=t.color3.create()};O.prototype.setNode=function e(t){this._node=t};var F=function e(){this._node=null;this._perspective=r.PP_PROJECTION;this._near=.01;this._far=1e3;this._fov=Math.PI/4;this._orthoHeight=10;this._rect={x:0,y:0,w:1,h:1};this._scissor={x:0,y:0,w:1,h:1};this._color=t.color4.create();this._view=t.mat4.create();this._proj=t.mat4.create();this._viewProj=t.mat4.create();this._invViewProj=t.mat4.create()};F.prototype.setNode=function e(t){this._node=t};F.prototype.updateMatrix=function e(){this._node.getWorldMatrix(this._view);t.mat4.invert(this._view,this._view);var n=this._rect.w/this._rect.h;if(this._perspective===r.PP_PROJECTION){t.mat4.perspective(this._proj,this._fov,n,this._near,this._far)}else{var i=this._orthoHeight*n;var a=this._orthoHeight;t.mat4.ortho(this._proj,-i,i,-a,a,this._near,this._far)}t.mat4.mul(this._viewProj,this._proj,this._view);t.mat4.invert(this._invViewProj,this._viewProj)};var R=function e(){this._node=null;this._meshes=[];this._materials=[]};var g={meshCount:{}};R.prototype.setNode=function e(t){this._node=t};R.prototype.addMesh=function e(t){if(this._meshes.indexOf(t)!==-1){return}this._meshes.push(t)};R.prototype.addMaterial=function e(t){if(this._materials.indexOf(t)!==-1){return}this._materials.push(t)};g.meshCount.get=function(){return this._meshes.length};R.prototype.getDrawItem=function e(t,n){if(n>=this._meshes.length){t.node=null;t.mesh=null;t.material=null;return}t.node=this._node;t.mesh=this._meshes[n];if(n<this._materials.length){t.material=this._materials[n]}else{t.material=this._materials[this._materials.length-1]}};Object.defineProperties(R.prototype,g);var N=function e(){this._lights=new n.FixedArray(16);this._models=new n.FixedArray(16)};N.prototype.addModel=function e(t){var n=this._models.indexOf(t);if(n===-1){this._models.push(t)}};N.prototype.removeModel=function e(t){var n=this._models.indexOf(t);if(n!==-1){this._models.fastRemove(n)}};var M={};var w=Object.prototype.toString;var y=Array.isArray||function e(t){return w.call(t)==="[object Array]"};function L(e){return typeof e==="function"}function C(e){return y(e)?"array":typeof e}function S(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function B(e,t){return e!=null&&typeof e==="object"&&t in e}var k=RegExp.prototype.test;function D(e,t){return k.call(e,t)}var b=/\S/;function x(e){return!D(b,e)}var I={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function U(e){return String(e).replace(/[&<>"'`=\/]/g,function e(t){return I[t]})}var j=/\s*/;var q=/\s+/;var W=/\s*=/;var Z=/\s*\}/;var V=/#|\^|\/|>|\{|&|=|!/;function K(e,t){if(!e){return[]}var n=[];var r=[];var i=[];var a=false;var s=false;function o(){if(a&&!s){while(i.length){delete r[i.pop()]}}else{i=[]}a=false;s=false}var l,_,c;function u(e){if(typeof e==="string"){e=e.split(q,2)}if(!y(e)||e.length!==2){throw new Error("Invalid tags: "+e)}l=new RegExp(S(e[0])+"\\s*");_=new RegExp("\\s*"+S(e[1]));c=new RegExp("\\s*"+S("}"+e[1]))}u(t||M.tags);var h=new G(e);var f,p,v,d,A,m;while(!h.eos()){f=h.pos;v=h.scanUntil(l);if(v){for(var T=0,E=v.length;T<E;++T){d=v.charAt(T);if(x(d)){i.push(r.length)}else{s=true}r.push(["text",d,f,f+1]);f+=1;if(d==="\n"){o()}}}if(!h.scan(l)){break}a=true;p=h.scan(V)||"name";h.scan(j);if(p==="="){v=h.scanUntil(W);h.scan(W);h.scanUntil(_)}else if(p==="{"){v=h.scanUntil(c);h.scan(Z);h.scanUntil(_);p="&"}else{v=h.scanUntil(_)}if(!h.scan(_)){throw new Error("Unclosed tag at "+h.pos)}A=[p,v,f,h.pos];r.push(A);if(p==="#"||p==="^"){n.push(A)}else if(p==="/"){m=n.pop();if(!m){throw new Error('Unopened section "'+v+'" at '+f)}if(m[1]!==v){throw new Error('Unclosed section "'+m[1]+'" at '+f)}}else if(p==="name"||p==="{"||p==="&"){s=true}else if(p==="="){u(v)}}m=n.pop();if(m){throw new Error('Unclosed section "'+m[1]+'" at '+h.pos)}return H(z(r))}function z(e){var t=[];var n,r;for(var i=0,a=e.length;i<a;++i){n=e[i];if(n){if(n[0]==="text"&&r&&r[0]==="text"){r[1]+=n[1];r[3]=n[3]}else{t.push(n);r=n}}}return t}function H(e){var t=[];var n=t;var r=[];var i,a;for(var s=0,o=e.length;s<o;++s){i=e[s];switch(i[0]){case"#":case"^":n.push(i);r.push(i);n=i[4]=[];break;case"/":a=r.pop();a[5]=i[2];n=r.length>0?r[r.length-1][4]:t;break;default:n.push(i)}}return t}function G(e){this.string=e;this.tail=e;this.pos=0}G.prototype.eos=function e(){return this.tail===""};G.prototype.scan=function e(t){var n=this.tail.match(t);if(!n||n.index!==0){return""}var r=n[0];this.tail=this.tail.substring(r.length);this.pos+=r.length;return r};G.prototype.scanUntil=function e(t){var n=this.tail.search(t),r;switch(n){case-1:r=this.tail;this.tail="";break;case 0:r="";break;default:r=this.tail.substring(0,n);this.tail=this.tail.substring(n)}this.pos+=r.length;return r};function X(e,t){this.view=e;this.cache={".":this.view};this.parent=t}X.prototype.push=function e(t){return new X(t,this)};X.prototype.lookup=function e(t){var n=this.cache;var r;if(n.hasOwnProperty(t)){r=n[t]}else{var i=this,a,s,o=false;while(i){if(t.indexOf(".")>0){r=i.view;a=t.split(".");s=0;while(r!=null&&s<a.length){if(s===a.length-1){o=B(r,a[s])}r=r[a[s++]]}}else{r=i.view[t];o=B(i.view,t)}if(o){break}i=i.parent}n[t]=r}if(L(r)){r=r.call(this.view)}return r};function Y(){this.cache={}}Y.prototype.clearCache=function e(){this.cache={}};Y.prototype.parse=function e(t,n){var r=this.cache;var i=r[t];if(i==null){i=r[t]=K(t,n)}return i};Y.prototype.render=function e(t,n,r){var i=this.parse(t);var a=n instanceof X?n:new X(n);return this.renderTokens(i,a,r,t)};Y.prototype.renderTokens=function e(t,n,r,i){var a=this;var s="";var o,l,_;for(var c=0,u=t.length;c<u;++c){_=undefined;o=t[c];l=o[0];if(l==="#"){_=a.renderSection(o,n,r,i)}else if(l==="^"){_=a.renderInverted(o,n,r,i)}else if(l===">"){_=a.renderPartial(o,n,r,i)}else if(l==="&"){_=a.unescapedValue(o,n)}else if(l==="name"){_=a.escapedValue(o,n)}else if(l==="text"){_=a.rawValue(o)}if(_!==undefined){s+=_}}return s};Y.prototype.renderSection=function e(t,n,r,i){var a=this;var s=this;var o="";var l=n.lookup(t[1]);function _(e){return s.render(e,n,r)}if(!l){return}if(y(l)){for(var c=0,u=l.length;c<u;++c){o+=a.renderTokens(t[4],n.push(l[c]),r,i)}}else if(typeof l==="object"||typeof l==="string"||typeof l==="number"){o+=this.renderTokens(t[4],n.push(l),r,i)}else if(L(l)){if(typeof i!=="string"){throw new Error("Cannot use higher-order sections without the original template")}l=l.call(n.view,i.slice(t[3],t[5]),_);if(l!=null){o+=l}}else{o+=this.renderTokens(t[4],n,r,i)}return o};Y.prototype.renderInverted=function e(t,n,r,i){var a=n.lookup(t[1]);if(!a||y(a)&&a.length===0){return this.renderTokens(t[4],n,r,i)}};Y.prototype.renderPartial=function e(t,n,r){if(!r){return}var i=L(r)?r(t[1]):r[t[1]];if(i!=null){return this.renderTokens(this.parse(i),n,r,i)}};Y.prototype.unescapedValue=function e(t,n){var r=n.lookup(t[1]);if(r!=null){return r}};Y.prototype.escapedValue=function e(t,n){var r=n.lookup(t[1]);if(r!=null){return M.escape(r)}};Y.prototype.rawValue=function e(t){return t[1]};M.name="mustache.js";M.version="2.3.0";M.tags=["{{","}}"];var Q=new Y;M.clearCache=function e(){return Q.clearCache()};M.parse=function e(t,n){return Q.parse(t,n)};M.render=function e(t,n,r){if(typeof t!=="string"){throw new TypeError('Invalid template! Template should be a "string" '+'but "'+C(t)+'" was given as the first '+"argument for mustache#render(template, view, partials)")}return Q.render(t,n,r)};M.to_html=function e(t,n,r,i){var a=M.render(t,n,r);if(L(i)){i(a)}else{return a}};M.escape=U;M.Scanner=G;M.Context=X;M.Writer=Y;var J={"skinning.vert":"attribute vec4 a_weight;\nattribute vec4 a_joint;\nuniform sampler2D u_bonesTexture;\nuniform float u_bonesTextureSize;\nmat4 getBoneMatrix(const in float i) {\n  float size = u_bonesTextureSize;\n  float j = i * 4.0;\n  float x = mod(j, size);\n  float y = floor(j / size);\n  float dx = 1.0 / size;\n  float dy = 1.0 / size;\n  y = dy * (y + 0.5);\n  vec4 v1 = texture2D(u_bonesTexture, vec2(dx * (x + 0.5), y));\n  vec4 v2 = texture2D(u_bonesTexture, vec2(dx * (x + 1.5), y));\n  vec4 v3 = texture2D(u_bonesTexture, vec2(dx * (x + 2.5), y));\n  vec4 v4 = texture2D(u_bonesTexture, vec2(dx * (x + 3.5), y));\n  return mat4(v1, v2, v3, v4);\n}\nmat4 skinMatrix() {\n  return\n    getBoneMatrix(a_joint.x) * a_weight.x +\n    getBoneMatrix(a_joint.y) * a_weight.y +\n    getBoneMatrix(a_joint.z) * a_weight.z +\n    getBoneMatrix(a_joint.w) * a_weight.w\n    ;\n}","unpack-normal.frag":"vec3 unpackNormal(vec4 nmap) {\n  return nmap.xyz * 2.0 - 1.0;\n}"};var $=[{name:"simple",vert:"\nattribute vec3 a_position;\nuniform mat4 model;\nuniform mat4 viewProj;\n{{#useTexture}}\n  attribute vec3 a_uv;\n  varying vec2 uv;\n{{/useTexture}}\nvoid main () {\n  vec4 pos = viewProj * model * vec4(a_position, 1);\n  {{#useTexture}}\n    uv = a_uv;\n  {{/useTexture}}\n  gl_Position = pos;\n}",frag:"\n{{#useTexture}}\n  uniform sampler2D mainTexture;\n  varying vec2 uv;\n{{/useTexture}}\n{{#useColor}}\n  uniform vec4 color;\n{{/useColor}}\nvoid main () {\n  vec4 o = vec4(1, 1, 1, 1);\n  {{#useTexture}}\n    o *= texture2D(mainTexture, uv);\n  {{/useTexture}}\n  {{#useColor}}\n    o *= color;\n  {{/useColor}}\n  if (!gl_FrontFacing) {\n    gl_FragColor.rgb *= 0.5;\n  }\n  gl_FragColor = o;\n}",options:[{name:"useTexture"},{name:"useColor"}]}];var ee=function e(t,n,r){var i=this;if(n===void 0)n=[];if(r===void 0)r={};this._device=t;this._precision="precision highp float;\n";this._templates={};for(var a=0;a<$.length;++a){var s=$[a];i.define(s.name,s.vert,s.frag,s.options)}for(var o=0;o<n.length;++o){var l=n[o];i.define(l.name,l.vert,l.frag,l.options)}this._chunks={};Object.assign(this._chunks,J);Object.assign(this._chunks,r);this._cache={}};ee.prototype.define=function e(t,n,r,i){if(this._templates[t]){console.warn("Failed to define shader "+t+": already exists.");return}var a=0;var s=function(e){var t=i[e];t._offset=a;var n=1;if(t.min!==undefined&&t.max!==undefined){n=Math.ceil((t.max-t.min)*.5);t._map=function(e){return e-this._min<<t._offset}.bind(t)}else{t._map=function(){return 1<<t._offset}.bind(t)}a+=n;t._offset=a};for(var o=0;o<i.length;++o)s(o);n=this._precision+n;r=this._precision+r;M.parse(n);M.parse(r);this._templates[t]={name:t,vert:n,frag:r,options:i}};ee.prototype.getKey=function e(t,n){var r=0;var i=this._templates[t];for(var a=0;a<i.options.length;++a){var s=i.options[a];var o=n[s.name];if(o===undefined){continue}r|=s._map(o.value)}return r};ee.prototype.getProgram=function t(n,r){var i=this.getKey(n,r);var a=this._cache[i];if(a){return a}r.chunks=this._chunks;var s=this._templates[n];var o=M.render(s.vert,r);var l=M.render(s.frag,r);a=new e.Program(this._device,{vert:o,frag:l});a.link();this._cache[i]=a;return a};var te=t.mat3.create();var ne=t.mat4.create();var re=new n.FramePool(function(){return{stage:null,items:null}},8);var ie=new n.FramePool(function(){return new Float32Array(2)},8);var ae=new n.FramePool(function(){return new Float32Array(3)},8);var se=new n.FramePool(function(){return new Float32Array(4)},8);var oe=new n.FramePool(function(){return new Float32Array(9)},8);var le=new n.FramePool(function(){return new Float32Array(16)},8);var _e=new n.FramePool(function(){return new Int32Array(2)},8);var ce=new n.FramePool(function(){return new Int32Array(3)},8);var ue=new n.FramePool(function(){return new Int32Array(4)},8);var he={};he[r.PARAM_INT]=function(e){return e};he[r.PARAM_INT2]=function(e){return t.vec2.array(_e.alloc(),e)};he[r.PARAM_INT3]=function(e){return t.vec3.array(ce.alloc(),e)};he[r.PARAM_INT4]=function(e){return t.vec4.array(ue.alloc(),e)};he[r.PARAM_FLOAT]=function(e){return e};he[r.PARAM_FLOAT2]=function(e){return t.vec2.array(ie.alloc(),e)};he[r.PARAM_FLOAT3]=function(e){return t.vec3.array(ae.alloc(),e)};he[r.PARAM_FLOAT4]=function(e){return t.vec4.array(se.alloc(),e)};he[r.PARAM_COLOR3]=function(e){return t.color3.array(ae.alloc(),e)};he[r.PARAM_COLOR4]=function(e){return t.color4.array(se.alloc(),e)};he[r.PARAM_MAT2]=function(e){return t.mat2.array(se.alloc(),e)};he[r.PARAM_MAT3]=function(e){return t.mat3.array(oe.alloc(),e)};he[r.PARAM_MAT4]=function(e){return t.mat4.array(le.alloc(),e)};var fe=function e(i,a){this._device=i;this._programLib=new ee(i,a.programTemplates,a.programChunks);this._opts=a;this._type2defaultValue=(s={},s[r.PARAM_INT]=0,s[r.PARAM_INT2]=t.vec2.new(0,0),s[r.PARAM_INT3]=t.vec3.new(0,0,0),s[r.PARAM_INT4]=t.vec4.new(0,0,0,0),s[r.PARAM_FLOAT]=0,s[r.PARAM_FLOAT2]=t.vec2.new(0,0),s[r.PARAM_FLOAT3]=t.vec3.new(0,0,0),s[r.PARAM_FLOAT4]=t.vec4.new(0,0,0,0),s[r.PARAM_COLOR3]=t.color3.new(0,0,0),s[r.PARAM_COLOR4]=t.color4.new(0,0,0,1),s[r.PARAM_MAT2]=t.mat2.create(),s[r.PARAM_MAT3]=t.mat3.create(),s[r.PARAM_MAT4]=t.mat4.create(),s[r.PARAM_TEXTURE_2D]=a.defaultTexture,s[r.PARAM_TEXTURE_CUBE]=a.defaultTextureCube,s);var s;this._stage2fn={};this._drawItemsPools=new n.FramePool(function(){return new n.RecyclePool(function(){return{node:null,mesh:null,material:null}},100)},16);this._stageItemsPools=new n.FramePool(function(){return new n.RecyclePool(function(){return{node:null,mesh:null,material:null,technique:null,zdist:-1}},100)},16)};fe.prototype._reset=function e(){this._drawItemsPools.reset();this._stageItemsPools.reset()};fe.prototype._render=function e(t,n,r){var i=this;var a=this._device;a.setViewport(0,0,t._rect.w,t._rect.h);a.clear({color:[.3,.3,.3,1],depth:1});var s=this._drawItemsPools.alloc();s.reset();for(var o=0;o<n._models.length;++o){var l=n._models.data[o];for(var _=0;_<l.meshCount;++_){var c=s.add();l.getDrawItem(c,_)}}re.reset();for(var u=0;u<r.length;++u){var h=r[u];var f=i._stageItemsPools.alloc();f.reset();for(var p=0;p<s.length;++p){var v=s.data[p];var d=v.material.getTechnique(h);if(d){var A=f.add();A.node=v.node;A.mesh=v.mesh;A.material=v.material;A.technique=d;A.zdist=-1}}var m=re.alloc();m.stage=h;m.items=f}for(var T=0;T<re.length;++T){var E=re.data[T];var P=i._stage2fn[E.stage];P(t,E.items)}};fe.prototype._draw=function e(n){var i=this;var a=this._device;var s=this._programLib;var o=n.node;var l=n.mesh;var _=n.material;var c=n.technique;ie.reset();ae.reset();se.reset();oe.reset();le.reset();_e.reset();ce.reset();ue.reset();o.getWorldMatrix(ne);a.setUniform("model",t.mat4.array(le.alloc(),ne));t.mat3.transpose(te,t.mat3.invert(te,t.mat3.fromMat4(te,ne)));a.setUniform("normalMatrix",t.mat3.array(oe.alloc(),te));var u=0;for(var h=0;h<c._parameters.length;++h){var f=c._parameters[h];var p=_.getValue(f.name);if(p===undefined){p=f.val}if(p===undefined){p=i._type2defaultValue[f.type]}if(p===undefined){console.warn("Failed to set technique property "+f.name+", value not found.");continue}if(f.type===r.PARAM_TEXTURE_2D||f.type===r.PARAM_TEXTURE_CUBE){a.setTexture(f.name,p,u);++u}else{var v=he[f.type];var d=v(p);a.setUniform(f.name,d)}}for(var A=0;A<c._passes.length;++A){var m=c._passes[A];var T=l._vertexBuffer.count;a.setVertexBuffer(0,l._vertexBuffer);if(l._indexBuffer){a.setIndexBuffer(l._indexBuffer);T=l._indexBuffer.count}a.setPrimitiveType(l._primitiveType);var E=s.getProgram(m._programName,_._options);a.setProgram(E);a.setCullMode(m._cullMode);if(m._blend){a.enableBlend();a.setBlendFuncSep(m._blendSrc,m._blendDst,m._blendSrcAlpha,m._blendDstAlpha);a.setBlendEqSep(m._blendEq,m._blendAlphaEq);a.setBlendColor32(m._blendColor)}if(m._depthTest){a.enableDepthTest();a.setDepthFunc(m._depthFunc)}if(m._depthWrite){a.enableDepthWrite()}if(m._stencilTest){a.enableStencilTest();a.setStencilFuncFront(m._stencilFuncFront,m._stencilRefFront,m._stencilMaskFront);a.setStencilOpFront(m._stencilFailOpFront,m._stencilZFailOpFront,m._stencilZPassOpFront,m._stencilWriteMaskFront);a.setStencilFuncBack(m._stencilFuncBack,m._stencilRefBack,m._stencilMaskBack);a.setStencilOpBack(m._stencilFailOpBack,m._stencilZFailOpBack,m._stencilZPassOpBack,m._stencilWriteMaskBack)}a.draw(0,T)}};var pe={createMesh:l,parseMaterial:E,Pass:a,Technique:o,Material:P,Mesh:i,Light:O,Camera:F,Model:R,Scene:N,Base:fe,ProgramLib:ee};Object.assign(pe,r);return pe}(window.gfx,window.vmath,window.memop);
//# sourceMappingURL=renderer.min.js.map